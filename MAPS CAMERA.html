<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peta Monitoring Profesional</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- MarkerCluster (opsional saat >1000 titik) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- JSZip untuk KMZ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- PapaParse untuk CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#111;          /* dark */
      --panel:#0a0a0a;    /* panel */
      --muted:#222;       /* muted border */
      --text:#e5e7eb;     /* text */
      --accent:#22c55e;   /* green */
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    #map { width:100%; height:100vh; }

    /* Sidebar icon rail */
    #sidebar { position:absolute; inset:0 auto 0 0; width:64px; display:flex; flex-direction:column; gap:12px; padding:12px 10px; background:#000; z-index:1000; box-shadow: 2px 0 10px rgba(0,0,0,.5); }
    .menu-btn { width:44px; height:44px; border-radius:10px; display:grid; place-items:center; background:#171717; color:var(--accent); cursor:pointer; transition:.2s; user-select:none; font-size:20px; }
    .menu-btn:hover { background:var(--accent); color:#fff; transform: translateY(-1px); }

    /* Panels */
    .panel { position:absolute; top:12px; left:76px; width:320px; max-height:88vh; overflow:auto; background:rgba(0,0,0,.9); border:1px solid var(--muted); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.4); backdrop-filter: blur(8px); opacity:0; pointer-events:none; transform: translateX(-12px); transition: opacity .25s, transform .25s; z-index:999; }
    .panel.show { opacity:1; pointer-events:auto; transform: translateX(0); }
    .panel h2 { margin:0 0 10px 0; font-size:16px; font-weight:700; border-bottom:1px solid var(--muted); padding-bottom:6px; }
    .panel small { color:#9ca3af; }
    .panel-section { margin-top:10px; }

    /* Inputs & buttons */
    .btn { width:100%; border:0; background:var(--accent); color:#fff; border-radius:10px; padding:10px 12px; font-weight:600; cursor:pointer; transition:.2s; }
    .btn:hover { filter:brightness(0.95); }
    input[type=file]{ display:none; }

    /* Layer list */
    .layer-item{ display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px dashed #1f2937; }
    .layer-item:last-child{ border-bottom:0; }

    /* Popup image */
    .leaflet-popup-content { margin:8px; }
    .leaflet-popup-content img { display:block; width:220px; max-width:220px; border-radius:10px; margin:8px 0 0; object-fit:cover; }

    /* Cluster look tweaks (dark) */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background: rgba(34,197,94,.15); }
    .marker-cluster div { background: var(--accent); color:#fff; border:2px solid #052e16; }
  </style>
</head>
<body>
  <!-- Sidebar rail -->
  <div id="sidebar" aria-label="Sidebar">
    <div class="menu-btn" title="Statistik" onclick="togglePanel('stats')">üìä</div>
    <div class="menu-btn" title="Layer (KMZ/KML)" onclick="togglePanel('layers')">üìÇ</div>
    <div class="menu-btn" title="Gambar (Draw)" onclick="togglePanel('draw')">‚úèÔ∏è</div>
  </div>

  <!-- Panel: Statistik -->
  <section id="panel-stats" class="panel" aria-live="polite">
    <h2>üìä Statistik</h2>
    <div id="stats-info"><small>Memuat data...</small></div>
    <canvas id="stats-chart" width="280" height="280" class="panel-section"></canvas>
  </section>

  <!-- Panel: Layers -->
  <section id="panel-layers" class="panel">
    <h2>üìÇ Layer KMZ/KML</h2>
    <button class="btn" onclick="document.getElementById('kmzInput').click()">Upload .kmz / .kml</button>
    <input id="kmzInput" type="file" multiple accept=".kmz,.kml" />
    <div id="layerList" class="panel-section"></div>
    <div class="panel-section">
      <button class="btn" onclick="clearOverlayLayers()">üóëÔ∏è Hapus Semua Layer</button>
    </div>
  </section>

  <!-- Panel: Draw -->
  <section id="panel-draw" class="panel">
    <h2>‚úèÔ∏è Gambar</h2>
    <small>Gunakan toolbar di kanan atas peta untuk membuat polygon, polyline, atau marker. Fitur edit & hapus tersedia.</small>
  </section>

  <div id="map" role="application" aria-label="Peta Monitoring"></div>

  <script>
  // ========================= KONFIGURASI =========================
  const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTifVQt8HlXS1HiDgLSiC3vWgFrWO7ygGKG8_YCOQpVTRlBI_txOkcASymbFi7NUuF3poSx3i3b9vo0/pub?output=csv";
  const MAP_INIT = { center: [-2.98, 115.197], zoom: 6 }; // Indonesia Tengah sebagai default
  const CLUSTER_THRESHOLD = 1000; // gunakan cluster jika titik > ambang ini

  // ========================= INISIALISASI PETA ===================
  const map = L.map('map', { preferCanvas: true, zoomControl: true }).setView(MAP_INIT.center, MAP_INIT.zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors', maxZoom: 20, detectRetina: true
  }).addTo(map);

  // Draw controls
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);
  const drawControl = new L.Control.Draw({
    position: 'topright',
    edit: { featureGroup: drawnItems },
    draw: {
      polygon: { allowIntersection: false, showArea: true },
      rectangle: true, circle: false, marker: true, polyline: true
    }
  });
  map.addControl(drawControl);
  map.on(L.Draw.Event.CREATED, (e) => drawnItems.addLayer(e.layer));

  // ========================= PANEL TOGGLE ========================
  function togglePanel(which){
    const ids = ['stats','layers','draw'];
    ids.forEach(id => {
      const el = document.getElementById(`panel-${id}`);
      if(id === which) el.classList.toggle('show'); else el.classList.remove('show');
    });
  }

  // ========================= LAYER OVERLAY (KMZ/KML) ============
  const overlayLayers = {}; // name -> layerGroup
  const layerListEl = document.getElementById('layerList');

  function refreshLayerList(){
    layerListEl.innerHTML = '';
    Object.keys(overlayLayers).forEach(name => {
      const row = document.createElement('div');
      row.className = 'layer-item';
      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.checked = map.hasLayer(overlayLayers[name]);
      cb.onchange = () => cb.checked ? overlayLayers[name].addTo(map) : map.removeLayer(overlayLayers[name]);
      const label = document.createElement('span');
      label.textContent = name;
      row.appendChild(cb); row.appendChild(label);
      layerListEl.appendChild(row);
    });
  }

  function clearOverlayLayers(){
    Object.values(overlayLayers).forEach(l => map.removeLayer(l));
    Object.keys(overlayLayers).forEach(k => delete overlayLayers[k]);
    refreshLayerList();
  }

  document.getElementById('kmzInput').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    for(const file of files){
      try {
        if(file.name.toLowerCase().endsWith('.kmz')){
          await loadKMZ(file);
        } else if(file.name.toLowerCase().endsWith('.kml')) {
          const text = await file.text();
          addKMLLayer(text, file.name.replace(/\.[^/.]+$/, ''));
        }
      } catch(err){
        console.error('Gagal memuat layer', file.name, err);
        alert(`Gagal memuat ${file.name}. Lihat console untuk detail.`);
      }
    }
    e.target.value = '';
  });

  async function loadKMZ(file){
    const name = file.name.replace(/\.[^/.]+$/, '');
    const ab = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(ab);
    // cari file .kml di dalam KMZ
    let kmlFile = zip.file(/\.kml$/i)[0];
    if(!kmlFile) throw new Error('doc.kml tidak ditemukan di KMZ');
    const kmlText = await kmlFile.async('text');
    addKMLLayer(kmlText, name);
  }

  function addKMLLayer(kmlText, name){
    const xml = new DOMParser().parseFromString(kmlText, 'application/xml');
    const layer = L.layerGroup();

    const placemarks = [...xml.getElementsByTagName('Placemark')];
    placemarks.forEach(pm => {
      const nameEl = pm.getElementsByTagName('name')[0];
      const title = nameEl ? nameEl.textContent : 'Fitur';

      // Point
      const point = pm.getElementsByTagName('Point')[0];
      if(point){
        const coordTxt = point.getElementsByTagName('coordinates')[0]?.textContent?.trim();
        if(coordTxt){
          const [lon,lat] = coordTxt.split(',').map(Number);
          L.marker([lat,lon]).addTo(layer).bindPopup(title);
        }
      }
      // Polygon
      const poly = pm.getElementsByTagName('Polygon')[0];
      if(poly){
        const rings = [...poly.getElementsByTagName('coordinates')].map(el => el.textContent.trim());
        if(rings.length){
          const latlngs = rings.map(txt => txt.split(/\s+/).map(x => x.split(',').slice(0,2).map(Number)).map(([lon,lat]) => [lat,lon]));
          L.polygon(latlngs, { color:'#3b82f6', weight:2, fillOpacity:.25 }).addTo(layer).bindPopup(title);
        }
      }
      // LineString
      const line = pm.getElementsByTagName('LineString')[0];
      if(line){
        const txt = line.getElementsByTagName('coordinates')[0]?.textContent?.trim();
        if(txt){
          const latlngs = txt.split(/\s+/).map(v => v.split(',').slice(0,2).map(Number)).map(([lon,lat]) => [lat,lon]);
          L.polyline(latlngs, { color:'#10b981', weight:2 }).addTo(layer).bindPopup(title);
        }
      }
    });

    layer.addTo(map);
    overlayLayers[name] = layer;
    refreshLayerList();
  }

  // ========================= FETCH CSV & RENDER ===================
  async function loadSpreadsheet(){
    try {
      const res = await fetch(SHEET_CSV, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const csvText = await res.text();
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      const rows = parsed.data || [];

      const markersData = [];
      const typeCount = Object.create(null);

      for(const row of rows){
        const lat = parseFloat(row.Y);
        const lon = parseFloat(row.X);
        if(Number.isFinite(lat) && Number.isFinite(lon)){
          markersData.push(row);
          const key = (row.Tanaman || 'Tidak Dikenal').trim();
          typeCount[key] = (typeCount[key] || 0) + 1;
        }
      }

      console.log('Loaded:', markersData.length, 'points from spreadsheet');
      updateStatsPanel(markersData.length, Object.keys(typeCount).length);
      renderChart(typeCount);

      await renderPoints(markersData);
    } catch(err){
      console.error('Gagal memuat spreadsheet:', err);
      document.getElementById('stats-info').innerHTML = '<span style="color:#f87171">Gagal memuat data. Coba reload.</span>';
    }
  }

  function updateStatsPanel(totalPoints, jenisCount){
    const el = document.getElementById('stats-info');
    el.innerHTML = `<b>Total Titik:</b> ${totalPoints}<br/><b>Jenis Tanaman:</b> ${jenisCount}`;
  }

  function buildPopupHTML(row){
    const lokasi = row.Lokasi || '-';
    const tanaman = row.Tanaman || '-';
    const tinggi = row.Tinggi ? `${row.Tinggi} cm` : '-';
    const tgl = row.Tanggal || '-';
    const pengawas = row.Pengawas || '-';
    const vendor = row.Vendor || '-';
    const imgLink = row.LINK || row.Gambar || '';

    const imgTag = imgLink ? `<img src="${imgLink}" loading="lazy" referrerpolicy="no-referrer" alt="Foto ${tanaman}">` : '';

    return `
      <div style="min-width:220px">
        <div style="font-weight:700; margin-bottom:2px">${lokasi}</div>
        <div>üå± ${tanaman}</div>
        <div>üìè ${tinggi}</div>
        <div>üìÖ ${tgl}</div>
        <div>üë∑ ${pengawas}</div>
        <div>üè¢ ${vendor}</div>
        ${imgTag}
      </div>`;
  }

  async function renderPoints(rows){
    const coords = [];

    if(rows.length > CLUSTER_THRESHOLD){
      // Gunakan MarkerCluster dengan marker kecil (divIcon) supaya mirip circle marker
      const cluster = L.markerClusterGroup({
        chunkedLoading: true,
        spiderfyOnMaxZoom: true,
        disableClusteringAtZoom: 18,
      });
      const dotIcon = (color = '#22c55e') => L.divIcon({
        className: 'dot-icon',
        html: `<span style="display:inline-block;width:8px;height:8px;background:${color};border-radius:9999px;border:1px solid #064e3b"></span>` ,
        iconSize: [8,8], iconAnchor: [4,4]
      });

      rows.forEach(row => {
        const lat = parseFloat(row.Y), lon = parseFloat(row.X);
        if(!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        coords.push([lat,lon]);
        const m = L.marker([lat,lon], { icon: dotIcon() });
        m.bindPopup(buildPopupHTML(row));
        cluster.addLayer(m);
      });
      map.addLayer(cluster);
    } else {
      const group = L.layerGroup();
      rows.forEach(row => {
        const lat = parseFloat(row.Y), lon = parseFloat(row.X);
        if(!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        coords.push([lat,lon]);
        const marker = L.circleMarker([lat,lon], {
          radius: 4, color: '#22c55e', fillColor: '#22c55e', fillOpacity: .9, weight: .5
        });
        marker.bindPopup(buildPopupHTML(row));
        marker.addTo(group);
      });
      group.addTo(map);
    }

    if(coords.length){
      try { map.fitBounds(coords, { padding: [20,20] }); } catch(_) {}
    }
  }

  // ========================= CHART ===============================
  let pieChart;
  function renderChart(typeCount){
    const labels = Object.keys(typeCount);
    const data = Object.values(typeCount);
    const colors = labels.map(() => `hsl(${Math.floor(Math.random()*360)},70%,60%)`);

    const ctx = document.getElementById('stats-chart');
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, {
      type: 'pie',
      data: { labels, datasets: [{ data, backgroundColor: colors }] },
      options: {
        plugins: { legend: { labels: { color: '#fff', boxWidth: 14 } } },
        animation: { duration: 300 }
      }
    });
  }

  // ========================= STARTUP =============================
  loadSpreadsheet();
  </script>
</body>
</html>
