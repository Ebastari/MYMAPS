<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Peta Monitoring - Split Foto Interaktif</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body {
  margin:0;
  height:100%;
  font-family:"Inter",system-ui,sans-serif;
  background:#0f0f0f;
  color:#fff;
  overflow:hidden;
}
#container {
  display:flex;
  width:100%;
  height:100%;
  transition:all 0.4s ease;
}
#map {
  flex:1;
  height:100%;
  transition:width 0.4s ease;
  z-index:1;
}
#side-panel {
  width:0;
  overflow:hidden;
  background:#111;
  border-left:2px solid #333;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:center;
  opacity:0;
  transition:all 0.4s ease;
  position:relative;
}
#side-panel.show {
  width:40%;
  opacity:1;
  padding:16px;
}
#side-panel h2 {
  margin:0 0 10px 0;
  color:#22c55e;
}
#photo {
  width:100%;
  max-width:320px;
  max-height:260px;
  object-fit:contain;
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,0.6);
  margin:10px auto;
  display:block;
  background:#0f0f0f;
}
.info-line {
  margin:8px 0;
  font-size:14px;
}
a {
  color:#3b82f6;
  text-decoration:none;
}
a:hover {text-decoration:underline;}
#closeBtn {
  position:absolute;
  top:10px;
  right:10px;
  background:#333;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:6px 10px;
  cursor:pointer;
  transition:all 0.3s;
}
#closeBtn:hover {background:#22c55e;color:#000;}
.highlight-marker {
  fill-color:#fde047 !important;
  color:#facc15 !important;
  fill-opacity:1 !important;
}
#preview-container {
  display:none;
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  background:#000;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  z-index:100;
}
#preview-container.show {
  display:flex;
}
#preview-container img {
  max-width:90%;
  max-height:85%;
  border-radius:12px;
  object-fit:contain;
  box-shadow:0 0 20px rgba(0,0,0,0.8);
}
#closePreview {
  position:absolute;
  top:10px; right:15px;
  font-size:18px;
  color:#fff;
  background:#222;
  border:none;
  border-radius:8px;
  padding:6px 12px;
  cursor:pointer;
}
#closePreview:hover {background:#22c55e;color:#000;}
</style>
</head>
<body>

<div id="container">
  <div id="map"></div>

  <!-- PANEL FOTO -->
  <div id="side-panel">
    <button id="closeBtn" onclick="closePanel()">‚úñ Tutup</button>
    <h2>üì∑ Detail Titik</h2>
    <div id="info">Klik titik pada peta.</div>
    <img id="photo" src="" alt="" style="display:none;">
    <div id="linkArea"></div>

    <!-- Preview besar di area hitam -->
    <div id="preview-container">
      <button id="closePreview" onclick="closePreview()">‚úñ</button>
      <img id="previewImage" src="" alt="Preview">
    </div>
  </div>
</div>

<script>
// =================== CONFIG ===================
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTifVQt8HlXS1HiDgLSiC3vWgFrWO7ygGKG8_YCOQpVTRlBI_txOkcASymbFi7NUuF3poSx3i3b9vo0/pub?output=csv";

// =================== INIT MAP =================
const map = L.map('map', { preferCanvas:true }).setView([-2.98,115.197],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'¬© OpenStreetMap'
}).addTo(map);

// =================== UTIL: Convert Drive Link =================
function driveToDirect(url){
  if(!url) return "";
  const match = url.match(/[-\w]{25,}/);
  return match ? `https://drive.google.com/uc?export=view&id=${match[0]}` : url;
}

// =================== VARS ===================
let activeMarker = null;

// =================== LOAD SPREADSHEET =================
async function loadSpreadsheet(){
  const res = await fetch(SHEET_CSV);
  const csv = await res.text();
  const data = Papa.parse(csv,{header:true}).data;
  const coords = [];

  for(const row of data){
    const lat = parseFloat(row.Y), lon = parseFloat(row.X);
    if(isNaN(lat)||isNaN(lon)) continue;
    coords.push([lat,lon]);

    const marker = L.circleMarker([lat,lon],{
      radius:5,
      color:"#22c55e",
      fillColor:"#22c55e",
      fillOpacity:0.9,
      weight:0.5
    }).addTo(map);

    marker.on("click", ()=> showPhotoPanel(row, marker));
  }

  if(coords.length) map.fitBounds(coords);
}

// =================== PANEL FUNGSI =================
function showPhotoPanel(row, marker){
  const panel = document.getElementById("side-panel");
  const infoDiv = document.getElementById("info");
  const photoEl = document.getElementById("photo");
  const linkDiv = document.getElementById("linkArea");

  if(activeMarker){
    activeMarker.setStyle({ color:"#22c55e", fillColor:"#22c55e" });
  }

  marker.setStyle({ color:"#facc15", fillColor:"#fde047" });
  activeMarker = marker;

  panel.classList.add("show");

  const imgUrl = driveToDirect(row.LINK || row.Gambar || "");
  const link = imgUrl ? `<a href="#" onclick="showPreview('${imgUrl}');return false;">üëÅÔ∏è Lihat foto di panel</a>` : "";

  infoDiv.innerHTML = `
    <div class="info-line"><b>üìç Lokasi:</b> ${row.Lokasi||"-"}</div>
    <div class="info-line"><b>üå± Tanaman:</b> ${row.Tanaman||"-"}</div>
    <div class="info-line"><b>üìè Tinggi:</b> ${row.Tinggi||"-"} cm</div>
    <div class="info-line"><b>üìÖ Tanggal:</b> ${row.Tanggal||"-"}</div>
    <div class="info-line"><b>üë∑ Pengawas:</b> ${row.Pengawas||"-"}</div>
    <div class="info-line"><b>üè¢ Vendor:</b> ${row.Vendor||"-"}</div>
    <div class="info-line"><b>üß≠ Koordinat:</b> ${row.Y}, ${row.X}</div>
  `;

  if(imgUrl){
    photoEl.src = imgUrl;
    photoEl.style.display = "block";
    linkDiv.innerHTML = link;
  } else {
    photoEl.style.display = "none";
    linkDiv.innerHTML = "<i style='color:#777'>Tidak ada foto tersedia</i>";
  }

  if(row.Y && row.X){
    map.flyTo([parseFloat(row.Y), parseFloat(row.X)], 14, { duration: 1.2 });
  }
}

// =================== PREVIEW BESAR =================
function showPreview(imgUrl){
  const preview = document.getElementById("preview-container");
  const img = document.getElementById("previewImage");
  img.src = imgUrl;
  preview.classList.add("show");
}

function closePreview(){
  document.getElementById("preview-container").classList.remove("show");
}

// =================== TUTUP PANEL =================
function closePanel(){
  const panel = document.getElementById("side-panel");
  panel.classList.remove("show");
  if(activeMarker){
    activeMarker.setStyle({ color:"#22c55e", fillColor:"#22c55e" });
    activeMarker = null;
  }
}

loadSpreadsheet();
</script>
</body>
</html>
