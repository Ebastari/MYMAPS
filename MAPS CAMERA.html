<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Peta Monitoring Spreadsheet (CORS Fixed)</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  html,body{margin:0;height:100%;}
  #map{width:100%;height:100%;}
  .leaflet-popup-content img{width:200px;border-radius:6px;margin-top:4px;}
  .toolbar{
    position:absolute;top:10px;left:10px;z-index:1000;
    background:rgba(0,0,0,0.6);color:#fff;padding:8px 12px;border-radius:8px;
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="toolbar">üìä Memuat data dari Google Spreadsheet...</div>

<script>
// URL publik spreadsheet kamu
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTifVQt8HlXS1HiDgLSiC3vWgFrWO7ygGKG8_YCOQpVTRlBI_txOkcASymbFi7NUuF3poSx3i3b9vo0/pub?output=csv";
// Proxy untuk bypass CORS
const PROXY = "https://api.allorigins.win/raw?url=" + encodeURIComponent(SHEET_CSV);

const map = L.map('map').setView([-2.98,115.197],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const markers = L.layerGroup().addTo(map);

// Konversi link Google Drive ke direct image
function driveImage(url){
  const m = (url||"").match(/\/d\/([^/]+)/);
  return m ? `https://drive.google.com/uc?export=view&id=${m[1]}` : url;
}

fetch(PROXY)
  .then(r=>r.text())
  .then(csv=>{
    const data = Papa.parse(csv,{header:true}).data;
    const coords=[];
    data.forEach(row=>{
      const lat = parseFloat(row.Y);
      const lon = parseFloat(row.X);
      if(isNaN(lat)||isNaN(lon)) return;
      const img = row.LINK ? `<img src="${driveImage(row.LINK)}">` : "";
      const html = `
        <b>${row.Lokasi||"Tanpa Nama"}</b><br>
        Pekerjaan: ${row.Pekerjaan||"-"}<br>
        Tanaman: ${row.Tanaman||"-"}<br>
        Tinggi: ${row.Tinggi||"-"} cm<br>
        Tahun Tanam: ${row["Tahun Tanam"]||"-"}<br>
        Pengawas: ${row.Pengawas||"-"}<br>
        Vendor: ${row.Vendor||"-"}<br>
        ${img}
      `;
      L.marker([lat,lon]).addTo(markers).bindPopup(html);
      coords.push([lat,lon]);
    });
    if(coords.length){
      map.fitBounds(coords);
      document.querySelector(".toolbar").textContent = `‚úÖ Berhasil memuat ${coords.length} titik dari Spreadsheet.`;
    } else {
      document.querySelector(".toolbar").textContent = "‚ö†Ô∏è Tidak ada titik valid di CSV.";
    }
  })
  .catch(err=>{
    document.querySelector(".toolbar").textContent = "‚ùå Gagal memuat CSV: " + err;
  });
</script>
</body>
</html>
