<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Peta Monitoring - Split View Foto Proporsional</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body {
  margin:0;
  height:100%;
  font-family:"Inter",system-ui,sans-serif;
  background:#0f0f0f;
  color:#fff;
  display:flex;
}
#map {
  width:65%;
  height:100vh;
}
#side-panel {
  width:35%;
  height:100vh;
  background:#1a1a1a;
  border-left:2px solid #333;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:center;
  padding:16px;
  box-sizing:border-box;
  overflow-y:auto;
  transition:all 0.3s ease;
}
#side-panel h2 {
  margin-top:0;
  color:#22c55e;
}
#photo {
  width:100%;
  max-width:280px;
  max-height:280px;
  object-fit:contain; /* ‚úÖ menjaga rasio */
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,0.6);
  margin:10px auto;
  display:block;
  background:#0f0f0f;
}
.info-line {
  margin:8px 0;
  font-size:14px;
}
a {
  color:#3b82f6;
  text-decoration:none;
}
a:hover {text-decoration:underline;}
@media (max-width:900px){
  #map{width:100%;}
  #side-panel{position:absolute;right:0;top:0;width:90%;background:rgba(0,0,0,0.95);}
}
</style>
</head>
<body>

<div id="map"></div>

<!-- PANEL FOTO -->
<div id="side-panel">
  <h2>üì∑ Detail Titik</h2>
  <div id="info">Klik salah satu titik di peta untuk melihat detailnya.</div>
  <img id="photo" src="" alt="" style="display:none;">
  <div id="linkArea"></div>
</div>

<script>
// =================== CONFIG ===================
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTifVQt8HlXS1HiDgLSiC3vWgFrWO7ygGKG8_YCOQpVTRlBI_txOkcASymbFi7NUuF3poSx3i3b9vo0/pub?output=csv";

// =================== INIT MAP =================
const map = L.map('map', { preferCanvas:true }).setView([-2.98,115.197],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'¬© OpenStreetMap'
}).addTo(map);

// =================== UTIL: Convert Drive Link =================
function driveToDirect(url){
  if(!url) return "";
  const match = url.match(/[-\w]{25,}/);
  return match ? `https://drive.google.com/uc?export=view&id=${match[0]}` : url;
}

// =================== LOAD SPREADSHEET =================
async function loadSpreadsheet(){
  const res = await fetch(SHEET_CSV);
  const csv = await res.text();
  const data = Papa.parse(csv,{header:true}).data;

  const coords = [];

  for(const row of data){
    const lat = parseFloat(row.Y), lon = parseFloat(row.X);
    if(isNaN(lat)||isNaN(lon)) continue;
    coords.push([lat,lon]);

    const marker = L.circleMarker([lat,lon],{
      radius:4,color:"#22c55e",fillColor:"#22c55e",fillOpacity:0.9,weight:0.5
    }).addTo(map);

    marker.on("click", ()=> showPhotoPanel(row));
  }

  if(coords.length) map.fitBounds(coords);
}

// =================== SIDE PANEL =================
function showPhotoPanel(row){
  const infoDiv = document.getElementById("info");
  const photoEl = document.getElementById("photo");
  const linkDiv = document.getElementById("linkArea");

  const imgUrl = driveToDirect(row.LINK || row.Gambar || "");
  const link = imgUrl ? `<a href="${imgUrl}" target="_blank">üîó Lihat di Google Drive</a>` : "";

  infoDiv.innerHTML = `
    <div class="info-line"><b>üìç Lokasi:</b> ${row.Lokasi||"-"}</div>
    <div class="info-line"><b>üå± Tanaman:</b> ${row.Tanaman||"-"}</div>
    <div class="info-line"><b>üìè Tinggi:</b> ${row.Tinggi||"-"} cm</div>
    <div class="info-line"><b>üìÖ Tanggal:</b> ${row.Tanggal||"-"}</div>
    <div class="info-line"><b>üë∑ Pengawas:</b> ${row.Pengawas||"-"}</div>
    <div class="info-line"><b>üè¢ Vendor:</b> ${row.Vendor||"-"}</div>
    <div class="info-line"><b>üß≠ Koordinat:</b> ${row.Y}, ${row.X}</div>
  `;

  if(imgUrl){
    photoEl.src = imgUrl;
    photoEl.style.display = "block";
    linkDiv.innerHTML = link;
  } else {
    photoEl.style.display = "none";
    linkDiv.innerHTML = "<i style='color:#777'>Tidak ada foto tersedia</i>";
  }

  // Fokuskan peta ke titik
  if(row.Y && row.X){
    map.flyTo([parseFloat(row.Y), parseFloat(row.X)], 14, { duration: 1.2 });
  }
}

// =================== START =================
loadSpreadsheet();
</script>
</body>
</html>
