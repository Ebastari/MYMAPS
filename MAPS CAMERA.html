<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Peta Monitoring - Klik Marker Langsung Foto</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body {
  margin:0;
  height:100%;
  font-family:"Inter",system-ui,sans-serif;
  background:#0f0f0f;
  color:#fff;
  overflow:hidden;
}
#container {
  display:flex;
  width:100%;
  height:100%;
  transition:all 0.4s ease;
}
#map {
  flex:1;
  height:100%;
  z-index:1;
}
#side-panel {
  width:0;
  overflow-y:auto;
  background:#111;
  border-left:2px solid #333;
  opacity:0;
  transition:all 0.4s ease;
  position:relative;
}
#side-panel.show {
  width:40%;
  opacity:1;
  padding:16px;
}
#side-panel h2 {
  margin:0 0 10px 0;
  color:#22c55e;
}
.info-line {
  margin:6px 0;
  font-size:14px;
}
#closeBtn {
  position:absolute;
  top:10px;
  right:10px;
  background:#333;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:6px 10px;
  cursor:pointer;
  transition:all 0.3s;
}
#closeBtn:hover {background:#22c55e;color:#000;}
#photo-frame {
  width:100%;
  height:auto;
  max-height:400px;
  margin-top:10px;
  border:none;
  border-radius:10px;
  background:#000;
  display:block;
  object-fit:contain;
}
@media (max-width:900px){
  #side-panel.show { width:100%; }
  #photo-frame { max-height:250px; }
}
</style>
</head>
<body>

<div id="container">
  <div id="map"></div>

  <!-- PANEL FOTO KANAN -->
  <div id="side-panel">
    <button id="closeBtn" onclick="closePanel()">‚úñ Tutup</button>
    <h2>üì∑ Foto Titik</h2>
    <div id="info">Klik titik pada peta.</div>
    <img id="photo-frame" alt="Foto Titik"/>
  </div>
</div>

<script>
// =================== KONFIGURASI ===================
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTifVQt8HlXS1HiDgLSiC3vWgFrWO7ygGKG8_YCOQpVTRlBI_txOkcASymbFi7NUuF3poSx3i3b9vo0/pub?output=csv";

// =================== INISIALISASI PETA ===================
const map = L.map('map', { preferCanvas:true }).setView([-2.98,115.197],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'¬© OpenStreetMap'
}).addTo(map);

// =================== FUNGSI KONVERSI LINK DRIVE ===================
function driveToEmbed(url){
  if(!url) return "";
  const match = url.match(/[-\w]{25,}/);
  return match ? `https://drive.google.com/uc?export=view&id=${match[0]}` : "";
}

let activeMarker = null;

// =================== LOAD DATA SPREADSHEET ===================
async function loadSpreadsheet(){
  const res = await fetch(SHEET_CSV);
  const csv = await res.text();
  const data = Papa.parse(csv,{header:true}).data;
  const coords = [];

  for(const row of data){
    const lat = parseFloat(row.Y), lon = parseFloat(row.X);
    if(isNaN(lat)||isNaN(lon)) continue;
    coords.push([lat,lon]);

    const marker = L.circleMarker([lat,lon],{
      radius:6,
      color:"#22c55e",
      fillColor:"#22c55e",
      fillOpacity:0.9,
      weight:1
    }).addTo(map);

    marker.on("click", ()=> showPhotoPanel(row, marker));
  }

  if(coords.length) map.fitBounds(coords);
}

// =================== PANEL FOTO ===================
function showPhotoPanel(row, marker){
  const panel = document.getElementById("side-panel");
  const infoDiv = document.getElementById("info");
  const imgFrame = document.getElementById("photo-frame");

  // Reset marker sebelumnya
  if(activeMarker){
    activeMarker.setStyle({ color:"#22c55e", fillColor:"#22c55e" });
  }
  marker.setStyle({ color:"#facc15", fillColor:"#fde047" });
  activeMarker = marker;

  // Tampilkan panel kanan
  panel.classList.add("show");

  // Isi informasi titik
  infoDiv.innerHTML = `
    <div class="info-line"><b>üìç Lokasi:</b> ${row.Lokasi||"-"}</div>
    <div class="info-line"><b>üå± Tanaman:</b> ${row.Tanaman||"-"}</div>
    <div class="info-line"><b>üìè Tinggi:</b> ${row.Tinggi||"-"} cm</div>
    <div class="info-line"><b>üìÖ Tanggal:</b> ${row.Tanggal||"-"}</div>
    <div class="info-line"><b>üë∑ Pengawas:</b> ${row.Pengawas||"-"}</div>
    <div class="info-line"><b>üè¢ Vendor:</b> ${row.Vendor||"-"}</div>
  `;

  // Ambil link Google Drive
  const embedUrl = driveToEmbed(row.LINK || row.Gambar || "");

  if(embedUrl){
    imgFrame.src = embedUrl;
    imgFrame.style.display = "block";
  } else {
    imgFrame.src = "";
    imgFrame.style.display = "none";
    infoDiv.innerHTML += `<div style="color:#888;margin-top:8px;">‚ö†Ô∏è Tidak ada foto tersedia</div>`;
  }

  // Fokus peta ke marker
  map.flyTo([parseFloat(row.Y), parseFloat(row.X)], 14, { duration: 1.0 });
}

// =================== TUTUP PANEL ===================
function closePanel(){
  const panel = document.getElementById("side-panel");
  panel.classList.remove("show");
  const imgFrame = document.getElementById("photo-frame");
  imgFrame.src = "";
  if(activeMarker){
    activeMarker.setStyle({ color:"#22c55e", fillColor:"#22c55e" });
    activeMarker = null;
  }
}

loadSpreadsheet();
</script>
</body>
</html>
