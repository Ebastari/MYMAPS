<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Peta Monitoring Profesional - Dashboard Sidebar</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body {
  margin:0;
  height:100%;
  background:#111;
  font-family:"Inter",system-ui,sans-serif;
}
#map {width:100%;height:100vh;}

/* Sidebar mini */
#sidebar {
  position:absolute;
  top:0; left:0;
  width:60px; height:100%;
  background:#000;
  display:flex; flex-direction:column;
  align-items:center;
  padding:10px 0;
  gap:10px;
  z-index:1000;
  box-shadow:2px 0 8px rgba(0,0,0,0.4);
}
.menu-btn {
  width:44px; height:44px;
  display:flex; align-items:center; justify-content:center;
  border-radius:8px;
  background:#1e1e1e;
  color:#22c55e;
  font-size:20px;
  cursor:pointer;
  transition:all 0.25s;
}
.menu-btn:hover { background:#22c55e; color:#fff; }

/* Panel konten kecil */
.panel {
  position:absolute;
  top:10px; left:70px;
  width:300px; max-height:90%;
  overflow-y:auto;
  background:rgba(0,0,0,0.9);
  color:#fff;
  padding:16px;
  border-radius:10px;
  backdrop-filter:blur(8px);
  box-shadow:0 0 10px rgba(0,0,0,0.5);
  transition:opacity 0.3s, transform 0.3s;
  opacity:0;
  pointer-events:none;
  transform:translateX(-20px);
  z-index:999;
}
.panel.show {
  opacity:1;
  pointer-events:auto;
  transform:translateX(0);
}
h2 {
  margin:0 0 8px 0;
  font-size:17px;
  border-bottom:1px solid #333;
  padding-bottom:4px;
}
button {
  background:#22c55e;
  border:none; color:#fff;
  border-radius:6px;
  padding:6px 10px;
  cursor:pointer; margin-top:8px;
  width:100%;
}
button:hover {background:#16a34a;}
input[type=file]{display:none;}
.layerItem {display:flex;align-items:center;gap:6px;margin:4px 0;}
canvas {margin-top:8px;}
.leaflet-popup-content img{width:200px;border-radius:8px;margin-top:8px;}
</style>
</head>

<body>
<div id="sidebar">
  <div class="menu-btn" title="Statistik" onclick="togglePanel('stats')">📊</div>
  <div class="menu-btn" title="Layer KMZ" onclick="togglePanel('layers')">📂</div>
  <div class="menu-btn" title="Gambar Polygon" onclick="togglePanel('draw')">✏️</div>
</div>

<div id="panel-stats" class="panel">
  <h2>📊 Statistik Monitoring</h2>
  <div id="info">Memuat data...</div>
  <canvas id="chart" width="260" height="260"></canvas>
</div>

<div id="panel-layers" class="panel">
  <h2>📂 Layer KMZ</h2>
  <button onclick="document.getElementById('kmzInput').click()">Upload KMZ</button>
  <input type="file" id="kmzInput" accept=".kmz,.kml" multiple>
  <div id="layerList"></div>
  <button onclick="clearLayers()">🗑️ Hapus Semua Layer</button>
</div>

<div id="panel-draw" class="panel">
  <h2>✏️ Gambar Polygon</h2>
  <p style="font-size:13px;color:#aaa;">Gunakan alat di kanan atas peta untuk menggambar polygon, garis, atau marker.</p>
</div>

<div id="map"></div>

<script>
// ========================== KONFIGURASI =============================
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTifVQt8HlXS1HiDgLSiC3vWgFrWO7ygGKG8_YCOQpVTRlBI_txOkcASymbFi7NUuF3poSx3i3b9vo0/pub?output=csv";
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYourScriptID/exec"; // Ganti dengan URL WebApp kamu
// ====================================================================

// ========================== INISIALISASI PETA =======================
const map = L.map('map', { preferCanvas:true }).setView([-2.98,115.197],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'© OpenStreetMap'
}).addTo(map);

// ========================== PANEL TOGGLE ============================
function togglePanel(id){
  const panels=['stats','layers','draw'];
  panels.forEach(p=>{
    const el=document.getElementById('panel-'+p);
    if(p===id) el.classList.toggle('show');
    else el.classList.remove('show');
  });
}

// ========================== LAYER MANAGER ===========================
const kmzLayers = {};
function refreshLayerList() {
  const div = document.getElementById("layerList");
  div.innerHTML = "";
  Object.keys(kmzLayers).forEach(name=>{
    const container = document.createElement("div");
    container.className="layerItem";
    const chk=document.createElement("input");
    chk.type="checkbox"; chk.checked=true;
    chk.onchange=()=> chk.checked ? map.addLayer(kmzLayers[name]) : map.removeLayer(kmzLayers[name]);
    const lbl=document.createElement("span");
    lbl.textContent=name;
    container.appendChild(chk);
    container.appendChild(lbl);
    div.appendChild(container);
  });
}

// ========================== KMZ LOADER ==============================
async function loadKMZ(file){
  const name=file.name.replace(/\.[^/.]+$/,"");
  const arrayBuffer=await file.arrayBuffer();
  const zip=await JSZip.loadAsync(arrayBuffer);
  const kmlText=await zip.file("doc.kml").async("text");
  const xml=new DOMParser().parseFromString(kmlText,"application/xml");

  const layer=L.layerGroup();
  const placemarks=xml.getElementsByTagName("Placemark");

  for(const p of placemarks){
    const coordsEl=p.getElementsByTagName("coordinates")[0];
    if(!coordsEl) continue;
    const coordsTxt=coordsEl.textContent.trim();
    const coordsArr=coordsTxt.split(/\s+/).map(c=>{
      const [lon,lat]=c.split(",").map(Number);
      return [lat,lon];
    });
    if(coordsArr.length===1){
      L.marker(coordsArr[0]).addTo(layer)
        .bindPopup(p.getElementsByTagName("name")[0]?.textContent||"Titik");
    } else if(coordsArr.length>2){
      L.polygon(coordsArr,{color:"#3b82f6",weight:2,fillOpacity:0.25})
        .addTo(layer)
        .bindPopup(p.getElementsByTagName("name")[0]?.textContent||"Area");
    }
  }

  kmzLayers[name]=layer;
  layer.addTo(map);
  refreshLayerList();
}
document.getElementById("kmzInput").addEventListener("change",async e=>{
  for(const f of e.target.files) await loadKMZ(f);
  e.target.value="";
});
function clearLayers(){
  Object.values(kmzLayers).forEach(l=>map.removeLayer(l));
  for(const k in kmzLayers) delete kmzLayers[k];
  refreshLayerList();
}

// ========================== POLYGON DRAW ============================
const drawnItems=new L.FeatureGroup();
map.addLayer(drawnItems);
const drawControl=new L.Control.Draw({
  position:'topright', // ✅ Geser toolbar ke kanan atas
  edit:{featureGroup:drawnItems},
  draw:{
    polygon:{allowIntersection:false,showArea:true},
    rectangle:true,circle:false,marker:true,polyline:true
  }
});
map.addControl(drawControl);
map.on(L.Draw.Event.CREATED,e=>drawnItems.addLayer(e.layer));

// ========================== FUNGSI AMBIL GAMBAR DARI PATH ============
async function getImageFromPath(path){
  if(!path) return '';
  try {
    const res = await fetch(`${APPS_SCRIPT_URL}?mode=getImage&path=${encodeURIComponent(path)}`);
    const json = await res.json();
    return json.url || '';
  } catch (err) {
    console.warn("Gagal ambil gambar:", err);
    return '';
  }
}

// ========================== LOAD SPREADSHEET DATA ===================
async function loadSpreadsheet(){
  document.getElementById("info").textContent = "📡 Memuat data dari spreadsheet...";
  const res = await fetch(SHEET_CSV);
  const csv = await res.text();
  const data = Papa.parse(csv,{header:true}).data;

  let total = 0;
  const typeCount = {};
  const coords = [];

  for(const row of data){
    const lat = parseFloat(row.Y), lon = parseFloat(row.X);
    if(isNaN(lat)||isNaN(lon)) continue;
    total++;
    coords.push([lat,lon]);
    const tanaman = (row.Tanaman||"Tidak Dikenal").trim();
    typeCount[tanaman] = (typeCount[tanaman]||0)+1;

    const marker = L.circleMarker([lat,lon],{
      radius:4,color:"#22c55e",fillColor:"#22c55e",fillOpacity:0.9,weight:0.5
    }).addTo(map);

    marker.on("click", async ()=>{
      const img = await getImageFromPath(row.Gambar);
      const html = `
        <b>${row.Lokasi||"-"}</b><br>
        🌱 ${row.Tanaman||"-"}<br>
        📏 ${row.Tinggi||"-"} cm<br>
        📅 ${row.Tanggal||"-"}<br>
        👷 ${row.Pengawas||"-"}<br>
        🏢 ${row.Vendor||"-"}<br>
        ${img ? `<img src="${img}" loading="lazy">` : ""}
      `;
      marker.bindPopup(html).openPopup();
    });
  }

  if(coords.length) map.fitBounds(coords);
  document.getElementById("info").innerHTML=`
    <b>Total Titik:</b> ${total}<br>
    <b>Jenis Tanaman:</b> ${Object.keys(typeCount).length}
  `;
  renderChart(typeCount);
  console.log("Loaded:", total, "points from spreadsheet");
}

// ========================== CHART ===========================
let chart;
function renderChart(obj){
  const ctx=document.getElementById("chart");
  const labels=Object.keys(obj);
  const values=Object.values(obj);
  const colors=labels.map(()=>`hsl(${Math.random()*360},70%,60%)`);
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'pie',
    data:{labels,datasets:[{data:values,backgroundColor:colors}]},
    options:{plugins:{legend:{labels:{color:'#fff',font:{size:12}}}}}
  });
}

// ========================== MULAI ===========================
loadSpreadsheet();
</script>
</body>
</html>
